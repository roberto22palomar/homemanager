<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitaciones</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        // Función para obtener el email del usuario actual
        async function obtenerUsuarioActual() {
            try {
                const response = await fetch('/homemanager/user/current-user', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    return user.email;
                } else {
                    throw new Error('Error al obtener el usuario actual.');
                }
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        // Función para obtener el nombre de la casa por ID
        async function obtenerNombreCasa(id) {
            try {
                const response = await fetch(`/homemanager/casa/${id}`);
                if (response.ok) {
                    const casa = await response.json();
                    return casa.nombre; // Supuesto nombre en el objeto CasaResponse
                } else {
                    throw new Error('Error al obtener el nombre de la casa.');
                }
            } catch (error) {
                console.error('Error:', error);
                return 'Desconocido';
            }
        }

        // Función para obtener las invitaciones por email
        async function obtenerInvitaciones(email) {
            try {
                const response = await fetch(`/homemanager/invitacion/getInvitaciones/${email}`);
                if (response.ok) {
                    const invitaciones = await response.json();
                    mostrarInvitaciones(invitaciones);
                } else {
                    alert('Error al obtener las invitaciones.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Función para mostrar las invitaciones en la interfaz
        async function mostrarInvitaciones(invitaciones) {
            const invitacionesContainer = document.getElementById('invitacionesContainer');
            invitacionesContainer.innerHTML = '';

            if (invitaciones.length === 0) {
                invitacionesContainer.innerHTML = '<div class="alert alert-warning">No tienes invitaciones pendientes.</div>';
                return;
            }

            for (const invitacion of invitaciones) {
                const casaNombre = await obtenerNombreCasa(invitacion.idCasa);

                const invitacionCard = document.createElement('div');
                invitacionCard.className = 'card mb-3';
                invitacionCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">Casa: ${casaNombre}</h5>
                        <p class="card-text">Estado: <strong>${invitacion.estado}</strong></p>
                        ${invitacion.estado === 'PENDIENTE' ? `
                        <button class="btn btn-success me-2" onclick="actualizarEstado('${invitacion.id}', 'ACEPTADA')">Aceptar</button>
                        <button class="btn btn-danger" onclick="actualizarEstado('${invitacion.id}', 'RECHAZADA')">Rechazar</button>
                        ` : `
                        <button class="btn btn-secondary" disabled>${invitacion.estado === 'ACEPTADA' ? 'Aceptada' : 'Rechazada'}</button>
                        `}
                    </div>
                `;
                invitacionesContainer.appendChild(invitacionCard);
            }
        }

        // Función para actualizar el estado de una invitación
        async function actualizarEstado(id, nuevoEstado) {
            try {
                const response = await fetch(`/homemanager/invitacion/${id}/estado?nuevoEstado=${nuevoEstado}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert(`La invitación ha sido ${nuevoEstado === 'ACEPTADA' ? 'aceptada' : 'rechazada'}.`);
                    // Actualizar la lista de invitaciones después de aceptar o rechazar
                    const email = await obtenerUsuarioActual();
                    if (email) {
                        obtenerInvitaciones(email);
                    }
                } else {
                    alert('Error al actualizar el estado.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Función para invitar a un nuevo usuario
        async function invitarUsuario(event) {
            event.preventDefault();
            const emailInvitado = document.getElementById('emailInvitado').value;

            const email = await obtenerUsuarioActual();
            if (!email) {
                alert('No se pudo obtener el usuario actual.');
                return;
            }

            const data = {
                email: emailInvitado,
                idCasa: idCasa
            };

            try {
                const response = await fetch('/homemanager/invitacion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Invitación creada: ' + JSON.stringify(result));
                    document.getElementById('invitarUsuarioForm').reset(); // Limpiar formulario
                } else {
                    alert('Error al crear la invitación.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Inicializar la página obteniendo las invitaciones
        document.addEventListener('DOMContentLoaded', async () => {
            const email = await obtenerUsuarioActual();
            if (email) {
                obtenerInvitaciones(email);
            }
        });
    </script>
</head>
<body>
<!-- Barra de navegación -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/homemanager/dashboard.html">Home Manager</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/homemanager/casa.html">Casa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/homemanager/tareas.html">Tareas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/homemanager/geolocalizacion.html">Geolocalización</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/homemanager/invitaciones.html">Invitaciones</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/homemanager/settings.html">Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link btn btn-danger text-white" href="/homemanager/logout">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <h1 class="mb-4 text-center">Tus Invitaciones</h1>

    <!-- Contenedor donde se mostrarán las invitaciones -->
    <div id="invitacionesContainer"></div>

    <!-- Formulario para invitar a un nuevo usuario -->
    <h2 class="mt-5">Invitar a un Usuario</h2>
    <form id="invitarUsuarioForm" onsubmit="invitarUsuario(event)">
        <div class="mb-3">
            <label for="emailInvitado" class="form-label">Correo electrónico del invitado</label>
            <input type="email" class="form-control" id="emailInvitado" name="emailInvitado" required>
        </div>
        <button type="submit" class="btn btn-primary">Enviar Invitación</button>
    </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
